{
  "version": "2.0",
  "generated_at": "2026-02-18T00:00:00Z",
  "description": "A2L Editor E2E 测试用例 - 针对最近修复问题",
  
  "test_cases": [
    {
      "id": "TC-SELECTION-001",
      "suite": "TS-SELECTION-FIX",
      "name": "test_search_filter_delete",
      "description": "测试搜索过滤后删除变量，验证选中状态使用名称而非索引",
      "priority": "critical",
      "related_issue": "#8",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "fill", "target": ".panel-left .search-bar input", "value": "existing" },
        { "action": "wait", "duration": 500 },
        { "action": "assert", "target": ".panel-left .list .row", "expect": "visible" },
        { "action": "click", "target": ".panel-left .list .row:first-child" },
        { "action": "assert", "target": ".panel-left .list .row.selected", "expect": "count:1" },
        { "action": "contextmenu", "target": ".panel-left .list .row.selected" },
        { "action": "wait_for_selector", "target": ".context-menu", "timeout": 1000 },
        { "action": "click", "target": ".context-menu button:has-text('删除')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已删除" }
      ],
      "expected_result": "删除的是选中名称的变量，而非显示位置对应的索引",
      "validation": {
        "type": "mock_state",
        "check": "deleted variable names match selected names"
      },
      "mock_requirements": ["delete_variables with names"]
    },
    {
      "id": "TC-SELECTION-002",
      "suite": "TS-SELECTION-FIX",
      "name": "test_search_filter_edit",
      "description": "测试搜索过滤后编辑变量，验证选中状态使用名称而非索引",
      "priority": "critical",
      "related_issue": "#8",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "fill", "target": ".panel-left .search-bar input", "value": "legacy" },
        { "action": "wait", "duration": 500 },
        { "action": "click", "target": ".panel-left .list .row:first-child" },
        { "action": "wait_for_selector", "target": ".editor input", "timeout": 2000 },
        { "action": "fill", "target": ".editor .field-input:first-of-type", "value": "ModifiedLegacyVar" },
        { "action": "click", "target": ".editor button:has-text('保存')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已保存" }
      ],
      "expected_result": "编辑的是选中名称的变量，而非显示位置对应的索引",
      "validation": {
        "type": "mock_state",
        "check": "modified variable name matches selected name"
      },
      "mock_requirements": ["save_a2l_changes"]
    },
    {
      "id": "TC-SELECTION-003",
      "suite": "TS-SELECTION-FIX",
      "name": "test_sort_then_delete",
      "description": "测试排序后删除变量，验证选中状态正确",
      "priority": "critical",
      "related_issue": "#8",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-left .table-header .sortable:last-child" },
        { "action": "wait", "duration": 300 },
        { "action": "click", "target": ".panel-left .list .row:nth-child(2)" },
        { "action": "contextmenu", "target": ".panel-left .list .row:nth-child(2)" },
        { "action": "click", "target": ".context-menu button:has-text('删除')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已删除" }
      ],
      "expected_result": "排序后删除的是选中名称的变量",
      "mock_requirements": ["delete_variables with names"]
    },
    {
      "id": "TC-SELECTION-004",
      "suite": "TS-SELECTION-FIX",
      "name": "test_copy_address_after_search",
      "description": "测试搜索后复制地址，验证复制的是正确变量的地址",
      "priority": "high",
      "related_issue": "#8",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "fill", "target": ".panel-left .search-bar input", "value": "variable_0001" },
        { "action": "wait", "duration": 500 },
        { "action": "click", "target": ".panel-left .list .row:first-child" },
        { "action": "contextmenu", "target": ".panel-left .list .row:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('复制地址')" },
        { "action": "wait", "duration": 200 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已复制" }
      ],
      "expected_result": "复制的是选中名称变量的地址",
      "validation": {
        "type": "clipboard",
        "check": "clipboard contains correct address"
      },
      "mock_requirements": ["writeText"]
    },
    {
      "id": "TC-OUTPUT-001",
      "suite": "TS-OUTPUT-FORMAT",
      "name": "test_measurement_block_format",
      "description": "测试 MEASUREMENT 块输出格式：变量名在 /begin 同行",
      "priority": "critical",
      "related_issue": "#12",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row:first-child" },
        { "action": "contextmenu", "target": ".panel-right .list .row:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('观测')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已添加" }
      ],
      "expected_result": "生成的 MEASUREMENT 块格式为 /begin MEASUREMENT name \"\"",
      "validation": {
        "type": "output_format",
        "pattern": "/begin MEASUREMENT \\w+ \"\"",
        "should_not_match": "/begin MEASUREMENT\\n\\s+\\w+"
      },
      "mock_requirements": ["export_entries", "generate_measurement_block"]
    },
    {
      "id": "TC-OUTPUT-002",
      "suite": "TS-OUTPUT-FORMAT",
      "name": "test_characteristic_block_format",
      "description": "测试 CHARACTERISTIC 块输出格式：变量名在 /begin 同行",
      "priority": "critical",
      "related_issue": "#12",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row:first-child" },
        { "action": "contextmenu", "target": ".panel-right .list .row:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('标定')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已添加" }
      ],
      "expected_result": "生成的 CHARACTERISTIC 块格式为 /begin CHARACTERISTIC name \"\"",
      "validation": {
        "type": "output_format",
        "pattern": "/begin CHARACTERISTIC \\w+ \"\"",
        "should_not_match": "/begin CHARACTERISTIC\\n\\s+\\w+"
      },
      "mock_requirements": ["export_entries", "generate_characteristic_block"]
    },
    {
      "id": "TC-OUTPUT-003",
      "suite": "TS-OUTPUT-FORMAT",
      "name": "test_first_variable_indentation",
      "description": "测试第一个添加的变量缩进正确（插入位置在行首）",
      "priority": "critical",
      "related_issue": "#13",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件（无现有变量）"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row:first-child" },
        { "action": "contextmenu", "target": ".panel-right .list .row:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('观测')" },
        { "action": "wait", "duration": 300 }
      ],
      "expected_result": "插入位置的缩进正确，不包含多余空白",
      "validation": {
        "type": "output_format",
        "check": "no leading whitespace before /begin"
      },
      "mock_requirements": ["append_to_file"]
    },
    {
      "id": "TC-OUTPUT-004",
      "suite": "TS-OUTPUT-FORMAT",
      "name": "test_parse_new_format",
      "description": "测试解析新格式 A2L 文件（变量名在 /begin 同行）",
      "priority": "critical",
      "related_issue": "#15-17",
      "preconditions": ["A2L 文件使用新格式"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "call_mock", "function": "setMockA2lVariables", "args": {"variables": "newFormatVariables"} },
        { "action": "call_test_helper", "function": "__test_loadFiles__", "args": [null, "/mock/new_format.a2l"] },
        { "action": "wait", "duration": 500 },
        { "action": "assert", "target": ".panel-left .list .row", "expect": "count:>0" }
      ],
      "expected_result": "新格式的变量被正确解析和显示",
      "mock_requirements": ["load_a2l", "parse_all_variables"]
    },
    {
      "id": "TC-OUTPUT-005",
      "suite": "TS-OUTPUT-FORMAT",
      "name": "test_remove_variables_new_format",
      "description": "测试删除新格式的变量",
      "priority": "critical",
      "related_issue": "#14",
      "preconditions": ["A2L 文件使用新格式", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "call_mock", "function": "setMockA2lVariables", "args": {"variables": "newFormatVariables"} },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-left .list .row:first-child" },
        { "action": "contextmenu", "target": ".panel-left .list .row:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('删除')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已删除" }
      ],
      "expected_result": "新格式的变量被正确识别和删除",
      "mock_requirements": ["delete_variables", "remove_variables"]
    },
    {
      "id": "TC-BITFIELD-001",
      "suite": "TS-BITFIELD",
      "name": "test_add_bitfield_measurement",
      "description": "测试添加 bitfield 变量为 MEASUREMENT，验证 BIT_MASK 生成",
      "priority": "critical",
      "related_issue": "#19",
      "preconditions": ["已加载包含 bitfield 的 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "call_mock", "function": "setMockElfEntries", "args": {"entries": "bitfieldEntries"} },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row[data-bitfield='true']:first-child" },
        { "action": "contextmenu", "target": ".panel-right .list .row[data-bitfield='true']:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('观测')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已添加" }
      ],
      "expected_result": "生成的 MEASUREMENT 块包含 BIT_MASK 字段",
      "validation": {
        "type": "output_format",
        "pattern": "BIT_MASK 0x[0-9A-Fa-f]+"
      },
      "mock_requirements": ["generate_measurement_block with BIT_MASK"]
    },
    {
      "id": "TC-BITFIELD-002",
      "suite": "TS-BITFIELD",
      "name": "test_add_bitfield_characteristic",
      "description": "测试添加 bitfield 变量为 CHARACTERISTIC，验证 BIT_MASK 生成",
      "priority": "critical",
      "related_issue": "#20",
      "preconditions": ["已加载包含 bitfield 的 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "call_mock", "function": "setMockElfEntries", "args": {"entries": "bitfieldEntries"} },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row[data-bitfield='true']:first-child" },
        { "action": "contextmenu", "target": ".panel-right .list .row[data-bitfield='true']:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('标定')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已添加" }
      ],
      "expected_result": "生成的 CHARACTERISTIC 块包含 BIT_MASK 字段",
      "validation": {
        "type": "output_format",
        "pattern": "BIT_MASK 0x[0-9A-Fa-f]+"
      },
      "mock_requirements": ["generate_characteristic_block with BIT_MASK"]
    },
    {
      "id": "TC-BITFIELD-003",
      "suite": "TS-BITFIELD",
      "name": "test_bitfield_mask_calculation",
      "description": "测试 BIT_MASK 计算正确性",
      "priority": "critical",
      "related_issue": "#19-20",
      "preconditions": [],
      "steps": [
        { "action": "call_mock", "function": "setMockElfEntries", "args": {"entries": "specificBitfieldEntries"} },
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row[data-bit-offset='4'][data-bit-size='3']" },
        { "action": "contextmenu", "target": ".panel-right .list .row[data-bit-offset='4'][data-bit-size='3']" },
        { "action": "click", "target": ".context-menu button:has-text('观测')" },
        { "action": "wait", "duration": 300 }
      ],
      "expected_result": "BIT_MASK = ((1 << bit_size) - 1) << bit_offset = 0x70",
      "validation": {
        "type": "mock_state",
        "check": "last_generated_block contains BIT_MASK 0x70"
      },
      "mock_requirements": ["calculate_bit_mask"]
    },
    {
      "id": "TC-REG-001",
      "suite": "TS-REGRESSION",
      "name": "test_normal_add_variable",
      "description": "回归测试：普通变量添加功能正常",
      "priority": "high",
      "preconditions": ["已加载 ELF 数据包", "已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row:first-child" },
        { "action": "contextmenu", "target": ".panel-right .list .row:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('观测')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已添加" }
      ],
      "expected_result": "普通变量正确添加到 A2L",
      "mock_requirements": ["export_entries"]
    },
    {
      "id": "TC-REG-002",
      "suite": "TS-REGRESSION",
      "name": "test_normal_edit_variable",
      "description": "回归测试：普通变量编辑功能正常",
      "priority": "high",
      "preconditions": ["已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-left .list .row:first-child" },
        { "action": "wait_for_selector", "target": ".editor", "timeout": 2000 },
        { "action": "fill", "target": ".editor .field-input:first-of-type", "value": "EditedVarName" },
        { "action": "click", "target": ".editor button:has-text('保存')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已保存" }
      ],
      "expected_result": "变量名称正确修改",
      "mock_requirements": ["save_a2l_changes"]
    },
    {
      "id": "TC-REG-003",
      "suite": "TS-REGRESSION",
      "name": "test_normal_delete_variable",
      "description": "回归测试：普通变量删除功能正常",
      "priority": "high",
      "preconditions": ["已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-left .list .row:first-child" },
        { "action": "contextmenu", "target": ".panel-left .list .row:first-child" },
        { "action": "click", "target": ".context-menu button:has-text('删除')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已删除" }
      ],
      "expected_result": "变量正确删除",
      "mock_requirements": ["delete_variables"]
    },
    {
      "id": "TC-REG-004",
      "suite": "TS-REGRESSION",
      "name": "test_search_functionality",
      "description": "回归测试：搜索功能正常",
      "priority": "high",
      "preconditions": ["已加载 ELF 数据包"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "fill", "target": ".panel-right .search-bar input", "value": "variable" },
        { "action": "wait", "duration": 500 },
        { "action": "assert", "target": ".panel-right .footer", "expect": "text:显示" }
      ],
      "expected_result": "搜索结果正确过滤",
      "mock_requirements": ["search_elf_entries"]
    },
    {
      "id": "TC-REG-005",
      "suite": "TS-REGRESSION",
      "name": "test_sort_functionality",
      "description": "回归测试：排序功能正常",
      "priority": "high",
      "preconditions": ["已加载 ELF 数据包"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .table-header .sortable:first-child" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".panel-right .table-header .sortable:first-child", "expect": "text:▼" }
      ],
      "expected_result": "排序指示器正确显示",
      "mock_requirements": ["search_elf_entries"]
    },
    {
      "id": "TC-REG-006",
      "suite": "TS-REGRESSION",
      "name": "test_multi_select_ctrl_click",
      "description": "回归测试：Ctrl+点击多选功能正常",
      "priority": "high",
      "preconditions": ["已加载 ELF 数据包"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-right .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-right .list .row:nth-child(1)" },
        { "action": "click", "target": ".panel-right .list .row:nth-child(2)", "modifiers": ["Control"] },
        { "action": "click", "target": ".panel-right .list .row:nth-child(3)", "modifiers": ["Control"] },
        { "action": "assert", "target": ".panel-right .list .row.selected", "expect": "count:3" }
      ],
      "expected_result": "多选功能正常",
      "mock_requirements": []
    },
    {
      "id": "TC-REG-007",
      "suite": "TS-REGRESSION",
      "name": "test_batch_delete",
      "description": "回归测试：批量删除功能正常",
      "priority": "high",
      "preconditions": ["已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-left .list .row:nth-child(1)" },
        { "action": "click", "target": ".panel-left .list .row:nth-child(2)", "modifiers": ["Control"] },
        { "action": "contextmenu", "target": ".panel-left .list .row:nth-child(2)" },
        { "action": "click", "target": ".context-menu button:has-text('删除')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已删除 2" }
      ],
      "expected_result": "批量删除功能正常",
      "mock_requirements": ["delete_variables"]
    },
    {
      "id": "TC-REG-008",
      "suite": "TS-REGRESSION",
      "name": "test_data_type_change",
      "description": "回归测试：数据类型修改功能正常",
      "priority": "high",
      "preconditions": ["已加载 A2L 文件"],
      "steps": [
        { "action": "goto", "target": "/" },
        { "action": "wait_for_selector", "target": ".panel-left .list .row", "timeout": 5000 },
        { "action": "click", "target": ".panel-left .list .row:first-child" },
        { "action": "wait_for_selector", "target": ".editor select", "timeout": 2000 },
        { "action": "select_option", "target": ".editor select:first-of-type", "value": "FLOAT32_IEEE" },
        { "action": "click", "target": ".editor button:has-text('保存')" },
        { "action": "wait", "duration": 300 },
        { "action": "assert", "target": ".status-bar", "expect": "text:已保存" }
      ],
      "expected_result": "数据类型正确修改",
      "mock_requirements": ["save_a2l_changes"]
    }
  ],

  "test_data": {
    "newFormatVariables": [
      { "name": "new_format_var_001", "address": "0x20010000", "data_type": "ULONG", "var_type": "MEASUREMENT" },
      { "name": "new_format_var_002", "address": "0x20010004", "data_type": "FLOAT32_IEEE", "var_type": "CHARACTERISTIC" }
    ],
    "bitfieldEntries": [
      { "index": 0, "full_name": "bitfield_var_001", "address": 0x20000000, "size": 4, "a2l_type": "UBYTE", "type_name": "uint8_t", "bit_offset": 0, "bit_size": 3 },
      { "index": 1, "full_name": "bitfield_var_002", "address": 0x20000000, "size": 4, "a2l_type": "UBYTE", "type_name": "uint8_t", "bit_offset": 3, "bit_size": 2 },
      { "index": 2, "full_name": "bitfield_var_003", "address": 0x20000000, "size": 4, "a2l_type": "UWORD", "type_name": "uint16_t", "bit_offset": 8, "bit_size": 4 }
    ],
    "specificBitfieldEntries": [
      { "index": 0, "full_name": "test_bitfield_calc", "address": 0x20000000, "size": 4, "a2l_type": "UBYTE", "type_name": "uint8_t", "bit_offset": 4, "bit_size": 3 }
    ]
  },

  "mock_requirements": {
    "commands": [
      "load_elf",
      "load_package", 
      "load_a2l",
      "search_elf_entries",
      "search_a2l_variables",
      "export_entries",
      "delete_variables",
      "save_a2l_changes",
      "set_endianness"
    ],
    "special_data": [
      "bitfield entries with bit_offset and bit_size",
      "new format A2L variables"
    ]
  },

  "metadata": {
    "total_test_cases": 20,
    "suites": 4,
    "critical_cases": 12,
    "high_cases": 8,
    "estimated_time": "15-25 minutes",
    "coverage": {
      "selection_fix": "100%",
      "output_format_fix": "100%",
      "bitfield_support": "100%",
      "regression": "80%"
    }
  }
}
